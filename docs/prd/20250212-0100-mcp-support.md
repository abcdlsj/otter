# Feature: MCP (Model Context Protocol) 支持

## 背景与动机

### 现状问题

当前 Otter 的工具集是内置的，虽然已经有 11 个实用工具，但存在以下限制：

1. **工具扩展困难**: 添加新工具需要修改源码、重新编译
2. **生态隔离**: 无法利用社区开发的工具（如数据库连接、API 客户端、云服务操作等）
3. **重复造轮子**: 常见的工具需求（如 PostgreSQL 查询、Docker 操作、AWS 管理）需要逐一实现
4. **维护负担**: 每个工具都需要在核心代码库中维护

### 什么是 MCP

[MCP (Model Context Protocol)](https://modelcontextprotocol.io) 是 Anthropic 提出的开放协议，用于标准化 AI 模型与外部工具的连接方式：

- **Server**: 提供工具、资源和提示的外部进程（通过 stdio 或 SSE）
- **Client**: 连接到 Server 并使用其能力的应用程序
- **协议**: 基于 JSON-RPC 的标准通信格式

现有的 MCP Server 生态：
- `mcp-server-filesystem` - 文件系统操作
- `mcp-server-postgres` - PostgreSQL 查询
- `mcp-server-github` - GitHub API 操作
- `mcp-server-puppeteer` - 浏览器自动化
- `mcp-server-slack` - Slack 集成
- ... 数十个社区贡献的 Server

### 为什么需要这个功能

1. **即插即用**: 通过配置即可使用社区工具，无需修改代码
2. **无限扩展**:  instantly 获得数百个工具能力
3. **专注核心**: Otter 专注做好 Agent 核心，工具交给生态
4. **安全隔离**: MCP Server 作为独立进程运行，更好的权限隔离
5. **生态兼容**: 与 Claude Desktop、Cursor 等工具共享 Server 生态

### 竞品对比

| 工具 | MCP 支持 | 说明 |
|------|----------|------|
| Claude Desktop | ✅ | 官方 MCP Client 实现 |
| Cursor | ⚠️ 计划中 | 已宣布支持计划 |
| Zed Editor | ✅ | 内置 MCP Client |
| Continue | ✅ | 开源 AI 代码助手 |
| Otter | ❌ | **待实现** |

---

## 功能描述

### 核心功能

1. **MCP Client 实现**: 完整的 MCP 协议客户端，支持 stdio 和 SSE 传输
2. **Server 配置管理**: 通过配置文件启用/配置 MCP Server
3. **工具自动发现**: 动态发现并集成 MCP Server 提供的工具
4. **资源访问**: 支持 MCP Resource（只读数据）的读取
5. **提示模板**: 支持 MCP Prompt（预定义提示模板）

### 使用场景

```
场景1: 使用 PostgreSQL MCP Server
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
用户: 查询用户表的前10条记录
Agent: [连接 mcp-server-postgres]
      [调用 query 工具: SELECT * FROM users LIMIT 10]
      → 返回查询结果

场景2: 使用 GitHub MCP Server
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
用户: 帮我创建一个新 Issue
Agent: [连接 mcp-server-github]
      [调用 create_issue 工具]
      → Issue 创建成功

场景3: 多 Server 协作
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
用户: 从数据库导出数据并生成报告
Agent: [postgres/query] 获取数据
      [filesystem/write] 写入 CSV
      [puppeteer/screenshot] 生成图表截图
```

### 配置示例

```toml
# ~/.config/otter/config.toml

[[mcp_servers]]
name = "filesystem"
command = "npx"
args = ["-y", "@modelcontextprotocol/server-filesystem", "/home/user/projects"]
env = { NODE_ENV = "production" }

[[mcp_servers]]
name = "postgres"
command = "npx"
args = ["-y", "@modelcontextprotocol/server-postgres", "postgresql://localhost/mydb"]

[[mcp_servers]]
name = "github"
command = "docker"
args = ["run", "-i", "--rm", "-e", "GITHUB_PERSONAL_ACCESS_TOKEN", "mcp/github"]
env = { GITHUB_PERSONAL_ACCESS_TOKEN = "ghp_xxx" }

[[mcp_servers]]
name = "fetch"
# SSE 传输方式
url = "http://localhost:3000/sse"
```

---

## 技术方案

### 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                         Otter                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   TUI/CLI   │  │    Agent    │  │    MCP Manager      │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
│         │                │                    │             │
│         └────────────────┴────────────────────┘             │
│                          │                                  │
│  ┌───────────────────────┼─────────────────────────────┐   │
│  │                       ▼                             │   │
│  │  ┌─────────────────────────────────────────────┐   │   │
│  │  │              Tool Set                       │   │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌───────────────┐ │   │   │
│  │  │  │ Built-in│ │  MCP    │ │  MCP Tools... │ │   │   │
│  │  │  │  Tools  │ │Client 1 │ │  (dynamic)    │ │   │   │
│  │  │  └─────────┘ └─────────┘ └───────────────┘ │   │   │
│  │  └─────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
└──────────────────────────┼──────────────────────────────────┘
                           │ stdio / SSE
           ┌───────────────┼───────────────┐
           ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │ MCP Server  │ │ MCP Server  │ │ MCP Server  │
    │ filesystem  │ │  postgres   │ │   github    │
    └─────────────┘ └─────────────┘ └─────────────┘
```

### 核心组件

#### 1. MCP Client (`internal/mcp/client.go`)

```go
package mcp

import (
    "context"
    "encoding/json"
    "io"
)

// Client MCP 客户端
type Client struct {
    name      string
    transport Transport
    tools     []Tool
    resources []Resource
    prompts   []Prompt
}

// Transport 抽象传输层
type Transport interface {
    Start(ctx context.Context) error
    Send(msg JSONRPCMessage) error
    Receive() (JSONRPCMessage, error)
    Close() error
}

// StdioTransport stdio 传输实现
type StdioTransport struct {
    cmd    *exec.Cmd
    stdin  io.WriteCloser
    stdout io.ReadCloser
    stderr io.ReadCloser
}

// SSETransport SSE 传输实现  
type SSETransport struct {
    url    string
    client *http.Client
    // SSE 连接管理
}

// JSONRPCMessage JSON-RPC 消息格式
type JSONRPCMessage struct {
    JSONRPC string          `json:"jsonrpc"`
    ID      interface{}     `json:"id,omitempty"`
    Method  string          `json:"method,omitempty"`
    Params  json.RawMessage `json:"params,omitempty"`
    Result  json.RawMessage `json:"result,omitempty"`
    Error   *JSONRPCError   `json:"error,omitempty"`
}

// 核心方法
func (c *Client) Initialize(ctx context.Context) error
func (c *Client) ListTools(ctx context.Context) ([]Tool, error)
func (c *Client) CallTool(ctx context.Context, name string, args map[string]interface{}) (CallToolResult, error)
func (c *Client) ListResources(ctx context.Context) ([]Resource, error)
func (c *Client) ReadResource(ctx context.Context, uri string) (ResourceContents, error)
func (c *Client) ListPrompts(ctx context.Context) ([]Prompt, error)
func (c *Client) GetPrompt(ctx context.Context, name string, args map[string]string) (GetPromptResult, error)
```

#### 2. MCP Manager (`internal/mcp/manager.go`)

```go
package mcp

import (
    "context"
    "sync"
    
    "github.com/abcdlsj/otter/internal/config"
    "github.com/abcdlsj/otter/internal/tool"
)

// Manager 管理所有 MCP Server 连接
type Manager struct {
    clients map[string]*Client
    tools   map[string]MCPTool  // name -> tool wrapper
    mu      sync.RWMutex
}

// MCPTool 适配器：将 MCP Tool 包装为 Otter Tool
type MCPTool struct {
    client *Client
    tool   Tool
}

func (m *MCPTool) Name() string { return "mcp_" + m.tool.Name }
func (m *MCPTool) Desc() string { return m.tool.Description }
func (m *MCPTool) Args() map[string]any { return m.tool.InputSchema }
func (m *MCPTool) Run(ctx context.Context, args json.RawMessage) (string, error) {
    result, err := m.client.CallTool(ctx, m.tool.Name, args)
    // 处理 result 转换为 string
}

// 管理方法
func (m *Manager) LoadFromConfig(cfg config.MCPConfig) error
func (m *Manager) StartAll(ctx context.Context) error
func (m *Manager) GetTools() []tool.Tool
func (m *Manager) GetClient(name string) *Client
func (m *Manager) Close() error
```

#### 3. 配置扩展 (`internal/config/config.go`)

```go
// MCPServerConfig MCP Server 配置
type MCPServerConfig struct {
    Name    string            `toml:"name"`
    Command string            `toml:"command,omitempty"`  // stdio 方式
    Args    []string          `toml:"args,omitempty"`
    Env     map[string]string `toml:"env,omitempty"`
    URL     string            `toml:"url,omitempty"`      // SSE 方式
    Enabled bool              `toml:"enabled"`
}

// 添加到主配置
type Config struct {
    Providers   []ProviderConfig  `toml:"providers"`
    MCPServers  []MCPServerConfig `toml:"mcp_servers"`
    Stream      bool              `toml:"stream"`
    MaxSteps    int               `toml:"max_steps"`
    Security    SecurityConfig    `toml:"security"`
    // ...
}
```

### 工具集成流程

```
1. 启动时初始化
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
main.go
  └─ config.Load()
       └─ 读取 mcp_servers 配置
  └─ mcpManager := mcp.NewManager()
  └─ mcpManager.LoadFromConfig(cfg)
       └─ 为每个 server 创建 Client
  └─ mcpManager.StartAll(ctx)
       └─ 启动每个 Client 的 transport
       └─ 发送 initialize 请求
       └─ 发送 tools/list 获取工具列表
       └─ 将工具包装为 MCPTool
  └─ toolSet.AddMCPTools(mcpManager.GetTools())

2. 运行时工具调用
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Agent.Run()
  └─ LLM 决定调用 "mcp_postgres_query"
  └─ toolSet.Get("mcp_postgres_query")
       └─ 找到 MCPTool 实例
  └─ mcptool.Run(ctx, args)
       └─ client.CallTool("query", args)
            └─ transport.Send(JSONRPC request)
            └─ 等待 response
       └─ 返回结果
```

### 文件改动清单

```
新增文件:
├── internal/mcp/
│   ├── client.go          # MCP Client 核心实现
│   ├── transport.go       # Transport 接口定义
│   ├── stdio.go           # StdioTransport 实现
│   ├── sse.go             # SSETransport 实现
│   ├── manager.go         # MCP Manager 管理多个 Client
│   ├── types.go           # MCP 协议类型定义
│   └── tool.go            # MCPTool 适配器
├── internal/mcp/protocol/
│   └── protocol.go        # JSON-RPC 协议常量

c修改文件:
├── internal/config/config.go
│   └── 添加 MCPServerConfig 结构体
├── internal/tool/tool.go
│   └── 修改 NewSet() 支持动态添加 MCP 工具
├── internal/agent/agent.go
│   └── 可选：添加 MCP 资源注入到 prompt
└── main.go
    └── 初始化 MCP Manager
```

---

## 接口设计

### 命令行接口

```bash
# 查看 MCP Server 状态
otter --mcp-status

# 输出示例:
# MCP Servers:
#   filesystem  ✅ connected  3 tools
#   postgres    ✅ connected  2 tools  
#   github      ❌ failed: connection refused

# 调试模式：显示 MCP 通信日志
otter --mcp-debug
```

### TUI 命令

```
/mcp                  显示 MCP Server 状态
/mcp reload           重新加载 MCP Server 配置
/mcp tools            列出所有 MCP 工具
```

### 配置接口

```toml
# MCP Server 配置完整示例
[[mcp_servers]]
name = "filesystem"
command = "npx"
args = ["-y", "@modelcontextprotocol/server-filesystem", "/home/user/workspace"]
enabled = true

[[mcp_servers]]
name = "postgres"
command = "uvx"
args = ["mcp-server-postgres", "--connection-string", "postgresql://user:pass@localhost/db"]
env = { PGSSLMODE = "disable" }
enabled = true

[[mcp_servers]]
name = "puppeteer"
command = "docker"
args = ["run", "-i", "--rm", "--init", "-e", "DOCKER_CONTAINER=true", "mcp/puppeteer"]
enabled = false  # 默认不启用

[[mcp_servers]]
name = "remote-fetch"
url = "https://mcp.example.com/sse"
enabled = true
```

---

## 验收标准

### 功能测试

- [ ] 可以通过配置启用 MCP Server（stdio 方式）
- [ ] 可以通过配置启用 MCP Server（SSE 方式）
- [ ] MCP 工具自动出现在可用工具列表中（带 `mcp_` 前缀）
- [ ] Agent 可以成功调用 MCP 工具并获取结果
- [ ] 支持 MCP Resource 读取（显示在 /context 中）
- [ ] MCP Server 故障不影响 Otter 核心功能
- [ ] 支持热重载 MCP 配置（/mcp reload）

### 错误处理

- [ ] MCP Server 启动失败时有清晰的错误提示
- [ ] MCP 工具调用超时（30s）后优雅降级
- [ ] MCP Server 崩溃后自动重连（最多 3 次）
- [ ] 无效的配置在启动时报错，不崩溃

### 性能测试

- [ ] 启动时间：添加 3 个 MCP Server 后启动时间 < 2s
- [ ] 内存占用：每个 MCP Client < 10MB
- [ ] 工具调用延迟：本地 stdio < 100ms，SSE < 500ms

### 安全测试

- [ ] MCP 工具受 SecurityConfig 权限控制
- [ ] MCP Server 无法访问配置外的路径（通过 args 限制）
- [ ] MCP 通信日志中隐藏敏感信息（API keys）

---

## 参考

### MCP 协议规范

- [Model Context Protocol Specification](https://spec.modelcontextprotocol.io/)
- [MCP Python SDK](https://github.com/modelcontextprotocol/python-sdk)
- [MCP TypeScript SDK](https://github.com/modelcontextprotocol/typescript-sdk)

### 参考实现

- [Claude Desktop MCP Client](https://github.com/modelcontextprotocol/servers)
- [Zed MCP 实现](https://github.com/zed-industries/zed/tree/main/crates/mcp)
- [Continue MCP 支持](https://docs.continue.dev/customize/tools)

### 相关 MCP Server

- [@modelcontextprotocol/server-filesystem](https://www.npmjs.com/package/@modelcontextprotocol/server-filesystem)
- [@modelcontextprotocol/server-postgres](https://www.npmjs.com/package/@modelcontextprotocol/server-postgres)
- [@modelcontextprotocol/server-github](https://www.npmjs.com/package/@modelcontextprotocol/server-github)
- [Awesome MCP Servers](https://github.com/punkpeye/awesome-mcp-servers)

---

## 附录：MCP 协议速览

### 核心能力

```go
// Server 提供的能力
type ServerCapabilities struct {
    Tools     *ToolsCapability     `json:"tools,omitempty"`
    Resources *ResourcesCapability `json:"resources,omitempty"`
    Prompts   *PromptsCapability   `json:"prompts,omitempty"`
    Logging   *LoggingCapability   `json:"logging,omitempty"`
}

// 工具定义
type Tool struct {
    Name        string                 `json:"name"`
    Description string                 `json:"description"`
    InputSchema map[string]interface{} `json:"inputSchema"`  // JSON Schema
}

// 资源定义
type Resource struct {
    URI         string `json:"uri"`
    Name        string `json:"name"`
    Description string `json:"description,omitempty"`
    MimeType    string `json:"mimeType,omitempty"`
}

// 提示模板定义
type Prompt struct {
    Name        string            `json:"name"`
    Description string            `json:"description,omitempty"`
    Arguments   []PromptArgument  `json:"arguments,omitempty"`
}
```

### 核心方法

| 方法 | 方向 | 说明 |
|------|------|------|
| `initialize` | Client → Server | 初始化连接，交换版本和能力 |
| `tools/list` | Client → Server | 获取可用工具列表 |
| `tools/call` | Client → Server | 调用指定工具 |
| `resources/list` | Client → Server | 获取可用资源列表 |
| `resources/read` | Client → Server | 读取资源内容 |
| `prompts/list` | Client → Server | 获取可用提示模板 |
| `prompts/get` | Client → Server | 获取提示模板内容 |
| `notifications/tools/list_changed` | Server → Client | 工具列表变更通知 |

### 通信示例

```json
// Client: initialize
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "initialize",
  "params": {
    "protocolVersion": "2024-11-05",
    "capabilities": {},
    "clientInfo": {"name": "otter", "version": "0.1.0"}
  }
}

// Server: response
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "protocolVersion": "2024-11-05",
    "capabilities": {"tools": {}},
    "serverInfo": {"name": "filesystem", "version": "1.0.0"}
  }
}

// Client: tools/list
{
  "jsonrpc": "2.0",
  "id": 2,
  "method": "tools/list"
}

// Client: tools/call
{
  "jsonrpc": "2.0",
  "id": 3,
  "method": "tools/call",
  "params": {
    "name": "read_file",
    "arguments": {"path": "/tmp/test.txt"}
  }
}
```

---

*PRD 创建时间: 2026-02-12*
*作者: OpenClaw Agent*
