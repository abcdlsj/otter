# Feature: Docker Container Tool

## 背景与动机

### 当前问题

开发者在日常工作中频繁需要与 Docker 容器交互，包括查看运行状态、日志分析、容器启停、镜像管理等。虽然 Otter 已有 `shell` 工具可以执行 docker 命令，但存在以下痛点：

1. **命令复杂难记**：Docker CLI 参数众多，记忆成本高
2. **输出不友好**：原始 docker 输出格式混乱，难以快速理解
3. **无法批量操作**：多容器管理需要逐个执行命令
4. **缺少状态汇总**：无法快速了解整个环境的容器状态
5. **日志查看不便**：查看实时日志、过滤日志体验差
6. **无智能建议**：无法根据容器状态给出优化建议

### 实际场景

```
场景1: 查看容器状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
用户: 看看现在有哪些容器在运行
现状: docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
问题: 命令复杂，输出不够直观

场景2: 查看日志
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
用户: 看看 web 容器的最新错误日志
现状: docker logs --tail 100 web_container
问题: 需要指定容器名，日志格式混乱

场景3: 容器启停
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
用户: 重启一下 redis 容器
现状: docker stop redis && docker start redis
问题: 两步操作，容易出错

场景4: 资源监控
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
用户: 哪个容器占用内存最高
现状: docker stats --no-stream
问题: 需要额外工具或脚本

场景5: 快速进入容器
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
用户: 进到 api 容器里看看
现状: docker exec -it api_container sh
问题: 需要知道容器名字和 shell 类型
```

### 用户价值

- **一键操作**：简化的命令完成复杂操作
- **友好输出**：表格化、颜色高亮、关键信息突出
- **批量管理**：同时操作多个容器
- **日志智能**：实时日志、过滤、搜索
- **状态汇总**：全局容器状态一目了然

### 与现有工具的关系

`docker` 工具不会替代 `shell` 工具，而是提供：
- 结构化的 Docker 接口
- 友好的输出格式
- 智能的默认配置
- 常用的快捷操作

`shell` 工具仍可用于：
- 复杂的 Docker 构建
- 自定义参数操作
- 不常用的 Docker 命令

## 功能描述

### 核心功能

#### 1. 容器列表
- 列出所有容器（运行中/已停止）
- 显示状态、镜像、端口、创建时间
- 过滤和搜索容器
- 批量选择操作

#### 2. 容器操作
- **启动/停止/重启**：单容器或批量
- **删除**：支持强制删除运行中容器
- **重启策略**：查看和修改重启策略
- **暂停/恢复**：暂停容器进程

#### 3. 日志管理
- **实时日志**：跟随日志输出
- **历史日志**：查看最近 N 行
- **过滤**：按级别、关键字过滤
- **时间范围**：指定时间段
- **错误高亮**：突出显示 ERROR/WARN

#### 4. 资源监控
- **CPU/内存**：实时资源使用
- **IO/网络**：磁盘和网络 IO
- **历史峰值**：查看资源峰值
- **按资源排序**：快速找到资源大户

#### 5. 容器交互
- **进入容器**：exec 进入 shell
- **执行命令**：在容器中执行命令
- **端口映射**：查看端口映射
- **环境变量**：查看容器环境变量

#### 6. 镜像管理
- **列出镜像**：查看本地镜像
- **镜像大小**：显示镜像大小
- **删除镜像**：清理未使用镜像
- **镜像历史**：查看构建历史

### 使用示例

#### 示例 1：列出容器
```json
{
  "action": "ps",
  "all": true
}
```

输出：
```
Containers (4 total, 2 running)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
NAME        IMAGE           STATUS     PORTS                    UP
──────────────────────────────────────────────────────────────────
web         nginx:alpine    Running    0.0.0.0:80->80/tcp       2h
api         myapp/api       Running    0.0.0.0:3000->3000/tcp   1h
redis       redis:7         Exited     -                        30m
db          postgres:15     Running    0.0.0.0:5432->5432/tcp   5h
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 示例 2：查看容器日志
```json
{
  "action": "logs",
  "container": "web",
  "tail": 50,
  "filter": "error"
}
```

输出：
```
Logs for web (last 50 lines, filtered by "error")
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
2026-02-22T01:15:32.123Z ERROR  [main] Failed to connect to database
2026-02-22T01:15:33.456Z ERROR  [main] Retrying connection...
2026-02-22T01:15:35.789Z WARN   [cache] Cache miss for key: user_42
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 示例 3：资源监控
```json
{
  "action": "stats",
  "stream": false
}
```

输出：
```
Container Resource Usage
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
CONTAINER    CPU %    MEM %    MEM     NET I/O      BLOCK I/O
──────────────────────────────────────────────────────
web          2.1%     45.2%   256MB   1.2KB/500B   10MB/2MB
api          15.3%    78.5%   512MB   50KB/20KB    100MB/50MB
db           5.2%     62.1%   1.2GB   100KB/80KB   500MB/200MB
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Sorted by memory usage (descending)
```

#### 示例 4：启动/停止容器
```json
{
  "action": "restart",
  "containers": ["redis", "cache"]
}
```

输出：
```
Restarting containers...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ redis - Stopped
✓ redis - Started
✓ cache - Stopped  
✓ cache - Started
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Completed in 3.2s
```

#### 示例 5：进入容器
```json
{
  "action": "exec",
  "container": "api",
  "command": "sh"
}
```

输出：
```
Entering container: api (sh)
/app # 
```

#### 示例 6：查看镜像
```json
{
  "action": "images"
}
```

输出：
```
Local Images (8)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
REPOSITORY        TAG       SIZE       CREATED       
──────────────────────────────────────────────────────────────────
nginx             alpine    25MB       2 days ago    
myapp/api         latest    150MB      1 week ago    
redis             7         110MB      2 weeks ago   
postgres          15        380MB      3 weeks ago   
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Total: 8 images, 1.2GB
```

## 技术方案

### 文件结构

```
internal/
├── docker/                     # 新增包
│   ├── docker.go               核心客户端 # 封装
│   ├── container.go             # 容器操作
│   ├── image.go                 # 镜像操作
│   ├── log.go                   # 日志处理
│   ├── stats.go                 # 资源统计
│   ├── formatter.go             # 输出格式化
│   └── types.go                 # 类型定义
└── tool/
    └── docker.go                # Docker 工具实现
```

### 核心实现

#### 1. Docker Client

```go
// internal/docker/docker.go

import (
    "github.com/docker/docker/client"
)

type Docker struct {
    cli *client.Client
}

func New() (*Docker, error) {
    cli, err := client.NewClientWithOpts(client.FromEnv)
    if err != nil {
        return nil, err
    }
    return &Docker{cli: cli}, nil
}

func (d *Docker) Close() error {
    return d.cli.Close()
}
```

#### 2. 容器列表

```go
// internal/docker/container.go

type Container struct {
    ID      string
    Names   []string
    Image   string
    Status  string
    State   string
    Ports   []Port
    Created time.Time
}

type Port struct {
    IP          string
    PrivatePort int
    PublicPort  int
    Type        string
}

func (d *Docker) List(ctx context.Context, all bool) ([]Container, error) {
    containers, err := d.cli.ContainerList(ctx, container.ListOptions{All: all})
    // 转换并返回
}
```

#### 3. 日志处理

```go
// internal/docker/log.go

type LogOptions struct {
    Container  string
    Tail       int
    Follow     bool
    Since      time.Time
    Timestamps bool
}

func (d *Docker) Logs(ctx context.Context, opts LogOptions) (io.ReadCloser, error) {
    return d.cli.ContainerLogs(ctx, opts.Container, container.LogsOptions{
        ShowStdout: true,
        ShowStderr: true,
        Tail:       strconv.Itoa(opts.Tail),
        Follow:     opts.Follow,
        Since:      opts.Since.Unix(),
        Timestamps: opts.Timestamps,
    })
}
```

#### 4. 资源统计

```go
// internal/docker/stats.go

type ContainerStats struct {
    ID        string
    Name      string
    CPUPerc   string
    MemPerc   string
    MemUsage  string
    NetIO     string
    BlockIO   string
}

func (d *Docker) Stats(ctx context.Context) ([]ContainerStats, error) {
    // 获取所有运行中的容器
    // 对每个容器调用 Stats
    // 返回统计信息
}
```

#### 5. Docker Tool

```go
// internal/tool/docker.go

type Docker struct{}

func (Docker) Name() string { return "docker" }
func (Docker) Desc() string {
    return "Manage Docker containers (ps, logs, stats, start, stop, exec)."
}

func (Docker) Args() map[string]any {
    return map[string]any{
        "type": "object",
        "properties": map[string]any{
            "action": map[string]any{
                "type": "string",
                "enum": []string{"ps", "logs", "stats", "start", "stop", "restart", "remove", "exec", "images", "inspect"},
                "description": "Docker action to perform",
            },
            "containers": map[string]any{
                "type": "array",
                "items": map[string]any{"type": "string"},
                "description": "Container names or IDs",
            },
            "container": map[string]any{
                "type": "string",
                "description": "Single container name or ID",
            },
            "all": map[string]any{
                "type": "boolean",
                "description": "Show all containers (including stopped)",
            },
            "tail": map[string]any{
                "type": "number",
                "description": "Number of log lines to show",
            },
            "filter": map[string]any{
                "type": "string",
                "description": "Filter logs by keyword",
            },
            "follow": map[string]any{
                "type": "boolean",
                "description": "Follow log output",
            },
            "stream": map[string]any{
                "type": "boolean",
                "description": "Stream stats (for stats action)",
            },
            "command": map[string]any{
                "type": "string",
                "description": "Command to execute (for exec action)",
            },
        },
    }
}

func (d *Docker) Run(ctx context.Context, raw json.RawMessage) (string, error) {
    var args struct {
        Action     string   `json:"action"`
        Containers []string `json:"containers"`
        Container  string   `json:"container"`
        All        bool     `json:"all"`
        Tail       int      `json:"tail"`
        Filter     string   `json:"filter"`
        Follow     bool     `json:"follow"`
        Stream     bool     `json:"stream"`
        Command    string   `json:"command"`
    }
    if err := json.Unmarshal(raw, &args); err != nil {
        return "", err
    }

    docker, err := docker.New()
    if err != nil {
        return "", err
    }
    defer docker.Close()

    switch args.Action {
    case "ps":
        return d.listContainers(ctx, docker, args.All)
    case "logs":
        return d.getLogs(ctx, docker, args.Container, args.Tail, args.Filter, args.Follow)
    case "stats":
        return d.getStats(ctx, docker, args.Stream)
    case "start":
        return d.startContainers(ctx, docker, args.Containers)
    case "stop":
        return d.stopContainers(ctx, docker, args.Containers)
    case "restart":
        return d.restartContainers(ctx, docker, args.Containers)
    case "remove":
        return d.removeContainers(ctx, docker, args.Containers)
    case "exec":
        return d.execContainer(ctx, docker, args.Container, args.Command)
    case "images":
        return d.listImages(ctx, docker)
    default:
        return "", fmt.Errorf("unknown action: %s", args.Action)
    }
}
```

### 依赖

```go
// go.mod

require (
    github.com/docker/docker v24.0.0+incompatible
    github.com/docker/cli v24.0.0+incompatible
)
```

## 接口设计

### 工具参数

```json
{
  "action": "ps",
  "all": true
}
```

```json
{
  "action": "logs",
  "container": "web",
  "tail": 100,
  "filter": "error"
}
```

```json
{
  "action": "stats",
  "stream": false
}
```

```json
{
  "action": "restart",
  "containers": ["redis", "cache"]
}
```

## 验收标准

### 功能验收

#### P0（必须实现）

- [ ] **容器列表**
  - [ ] 列出所有容器
  - [ ] 显示状态、镜像、端口
  - [ ] 支持 -a 显示已停止容器

- [ ] **容器操作**
  - [ ] 启动容器
  - [ ] 停止容器
  - [ ] 重启容器
  - [ ] 删除容器

- [ ] **日志查看**
  - [ ] 查看最近 N 行日志
  - [ ] 按关键字过滤
  - [ ] 显示时间戳

- [ ] **资源监控**
  - [ ] CPU 使用率
  - [ ] 内存使用
  - [ ] 网络 IO
  - [ ] 磁盘 IO

#### P1（强烈建议）

- [ ] **镜像管理**
  - [ ] 列出本地镜像
  - [ ] 显示镜像大小
  - [ ] 删除镜像

- [ ] **增强功能**
  - [ ] 实时日志跟踪 (follow)
  - [ ] 批量操作
  - [ ] 进入容器 (exec)

- [ ] **输出优化**
  - [ ] 表格化输出
  - [ ] 颜色高亮
  - [ ] 状态颜色区分

#### P2（可选）

- [ ] 容器健康检查
- [ ] 自动重启策略
- [ ] 容器资源限制查看
- [ ] Docker Compose 支持

### 代码质量验收

- [ ] 遵循 CLAUDE.md 代码风格
- [ ] 错误处理完善
- [ ] Docker 连接复用
- [ ] 单元测试覆盖

### 文档验收

- [ ] 工具描述清晰准确
- [ ] 参数文档完整
- [ ] 使用示例丰富

## 参考

### Docker Go SDK

- **docker/docker**: Docker Engine API SDK - https://github.com/docker/docker/client
- **docker/cli**: Docker CLI library - https://github.com/docker/cli

### 相关项目

- **dockly**: Terminal UI for Docker - https://github.com/moncho/dry
- **ctop**: Container metrics - https://github.com/bcicen/ctop
- **Docker Compose**: Multi-container orchestration

### 文档

- Docker Engine API: https://docs.docker.com/engine/api/
- Docker SDK for Go: https://docs.docker.com/engine/api/sdk/

---

**PRD 版本**: 1.0
**创建日期**: 2026-02-22
**预计工期**: 3-4 天
**优先级**: 中高（开发常用，提升效率）
