# Feature: Smart Tool Result Caching (æ™ºèƒ½å·¥å…·ç»“æœç¼“å­˜)

## èƒŒæ™¯ä¸åŠ¨æœº

### ç°çŠ¶é—®é¢˜

å½“å‰ Otter çš„ Agent æ¯æ¬¡è°ƒç”¨å·¥å…·éƒ½ä¼šé‡æ–°æ‰§è¡Œï¼Œå³ä½¿ï¼š

1. **ç›¸åŒçš„ websearch æŸ¥è¯¢** - ç”¨æˆ·å¤šæ¬¡è¯¢é—®ç›¸å…³è¯é¢˜ï¼Œæ¯æ¬¡éƒ½é‡æ–°æœç´¢
2. **é‡å¤çš„ git æ“ä½œ** - `git status`ã€`git log` åœ¨çŸ­æ—¶é—´å†…é¢‘ç¹æ‰§è¡Œ
3. **é‡å¤çš„ä»£ç æœç´¢** - ç›¸åŒçš„ grep æ¨¡å¼åœ¨å¯¹è¯ä¸­å¤šæ¬¡è¿è¡Œ
4. **æ–‡ä»¶åˆ—è¡¨** - `glob` å’Œ `list` æ“ä½œç»“æœå¾ˆå°‘å˜åŒ–

### å®é™…åœºæ™¯

```
åœºæ™¯1: é‡å¤æœç´¢
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç”¨æˆ·: Go çš„ context åŒ…æ€ä¹ˆç”¨ï¼Ÿ
Agent: [websearch] "Go context package usage" â†’ 3s
...
ç”¨æˆ·: è¿˜æœ‰å…¶ä»–çš„æœ€ä½³å®è·µå—ï¼Ÿ
Agent: [websearch] "Go context package usage" â†’ 3s (é‡å¤ï¼)

åœºæ™¯2: é¢‘ç¹çš„ git æ£€æŸ¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Agent: [git status] æ£€æŸ¥å·¥ä½œåŒºçŠ¶æ€
Agent: [git log --oneline -5] æŸ¥çœ‹æœ€è¿‘æäº¤
(30ç§’å)
Agent: [git status] å†æ¬¡æ£€æŸ¥ â†’ åº”è¯¥å¤ç”¨ç¼“å­˜

åœºæ™¯3: ä»£ç æ¢ç´¢
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Agent: [grep] "func.*Handler" æŸ¥æ‰¾å¤„ç†å™¨
ç”¨æˆ·: çœ‹çœ‹è¿™äº›å‡½æ•°çš„å®ç°
Agent: [view] file1.go
Agent: [grep] "func.*Handler" â†’ é‡å¤æ‰§è¡Œ
```

### æ€§èƒ½å½±å“

| æ“ä½œ | è€—æ—¶ | é¢‘ç‡ | æœˆç´¯è®¡* |
|------|------|------|---------|
| websearch | 1-3s | 20æ¬¡/å¤© | 60s |
| git log | 200ms | 50æ¬¡/å¤© | 10s |
| grep (å¤§é¡¹ç›®) | 500ms | 30æ¬¡/å¤© | 15s |
| glob | 100ms | 40æ¬¡/å¤© | 4s |

*åŸºäºå¹³å‡ä½¿ç”¨é‡ä¼°ç®—

### ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªåŠŸèƒ½

1. **æå‡å“åº”é€Ÿåº¦** - ç¼“å­˜å‘½ä¸­æ—¶ä»ç§’çº§é™åˆ°æ¯«ç§’çº§
2. **å‡å°‘ API è°ƒç”¨** - é™ä½æœç´¢ API æˆæœ¬
3. **æ”¹å–„ç”¨æˆ·ä½“éªŒ** - å¯¹è¯æ›´æµç•…ï¼Œå‡å°‘ç­‰å¾…
4. **èŠ‚èƒ½ç¯ä¿** - å‡å°‘ä¸å¿…è¦çš„è®¡ç®—å’Œç½‘ç»œè¯·æ±‚
5. **ç¦»çº¿å¯ç”¨** - ç¼“å­˜çš„ç»“æœåœ¨æ— ç½‘ç»œæ—¶ä»å¯æŸ¥çœ‹

### ç«å“å¯¹æ¯”

| å·¥å…· | ç»“æœç¼“å­˜ | è¯´æ˜ |
|------|----------|------|
| Claude Code | âš ï¸ æœ‰é™ | ä¼šè¯å†…éƒ¨åˆ†è®°å¿†ï¼Œä½†æ— ç»“æ„åŒ–ç¼“å­˜ |
| Cursor | âŒ | æ¯æ¬¡é‡æ–°æ‰§è¡Œ |
| Aider | âŒ | æ— ç¼“å­˜æœºåˆ¶ |
| GitHub Copilot | N/A | æ— å·¥å…·è°ƒç”¨ |
| **Otter** | **âœ… å¾…å®ç°** | **æ™ºèƒ½ç¼“å­˜ + è‡ªåŠ¨å¤±æ•ˆ** |

---

## åŠŸèƒ½æè¿°

### æ ¸å¿ƒåŠŸèƒ½

1. **é€æ˜ç¼“å­˜å±‚** - å·¥å…·è°ƒç”¨è‡ªåŠ¨ç»è¿‡ç¼“å­˜ï¼Œæ— éœ€ä¿®æ”¹å·¥å…·å®ç°
2. **æ™ºèƒ½å¤±æ•ˆç­–ç•¥** - æ ¹æ®å·¥å…·ç±»å‹è‡ªåŠ¨å†³å®šç¼“å­˜æœ‰æ•ˆæœŸ
3. **ä¾èµ–æ„ŸçŸ¥** - æ–‡ä»¶ç›¸å…³ç¼“å­˜éšæ–‡ä»¶ä¿®æ”¹è‡ªåŠ¨å¤±æ•ˆ
4. **ç¼“å­˜ç»Ÿè®¡** - æ˜¾ç¤ºå‘½ä¸­ç‡å’ŒèŠ‚çœæ—¶é—´
5. **æ‰‹åŠ¨æ§åˆ¶** - ç”¨æˆ·å¯æ¸…é™¤ç¼“å­˜æˆ–ç¦ç”¨ç‰¹å®šå·¥å…·ç¼“å­˜

### ç¼“å­˜ç­–ç•¥è®¾è®¡

```go
// å·¥å…·ç±»å‹ä¸ç¼“å­˜ç­–ç•¥æ˜ å°„
var cachePolicies = map[string]CachePolicy{
    // é™æ€ç»“æœ - é•¿æœŸç¼“å­˜
    "websearch":   {TTL: 1 * time.Hour,  Invalidation: "none"},
    "webfetch":    {TTL: 30 * time.Minute, Invalidation: "none"},
    
    // æ–‡ä»¶ç³»ç»Ÿæ“ä½œ - ä¾èµ–æ–‡ä»¶ä¿®æ”¹æ—¶é—´
    "view":        {TTL: 5 * time.Minute,  Invalidation: "mtime"},
    "list":        {TTL: 1 * time.Minute,  Invalidation: "mtime"},
    "glob":        {TTL: 1 * time.Minute,  Invalidation: "mtime"},
    
    // ä»£ç æœç´¢ - ä¾èµ–æ–‡ä»¶å†…å®¹å˜åŒ–
    "grep":        {TTL: 2 * time.Minute,  Invalidation: "content"},
    
    // Git æ“ä½œ - ä¾èµ– HEAD å˜åŒ–
    "git":         {TTL: 30 * time.Second, Invalidation: "git_head"},
    
    // æ°¸ä¸ç¼“å­˜ - å¯èƒ½äº§ç”Ÿå‰¯ä½œç”¨æˆ–é¢‘ç¹å˜åŒ–
    "shell":       {TTL: 0,                Invalidation: "never"},
    "edit":        {TTL: 0,                Invalidation: "never"},
    "compact":     {TTL: 0,                Invalidation: "never"},
}
```

### ä½¿ç”¨åœºæ™¯

```
åœºæ™¯1: ç¼“å­˜å‘½ä¸­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Agent: [websearch] "Go generics tutorial"
      â†’ [CACHE MISS] æ‰§è¡Œæœç´¢ (2.3s)
      â†’ å­˜å‚¨ç¼“å­˜ï¼ŒTTL: 1h
...
Agent: [websearch] "Go generics tutorial"  
      â†’ [CACHE HIT] ç›´æ¥è¿”å› (0.5ms)
      âš¡ èŠ‚çœ 2.3s

åœºæ™¯2: æ–‡ä»¶ä¿®æ”¹åè‡ªåŠ¨å¤±æ•ˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Agent: [view] main.go
      â†’ [CACHE MISS] è¯»å–æ–‡ä»¶ (5ms)
      â†’ è®°å½• mtime: 1707753600
...
(ç”¨æˆ·ç¼–è¾‘äº† main.goï¼Œmtime å˜ä¸º 1707753700)
...
Agent: [view] main.go
      â†’ [CACHE STALE] mtime æ”¹å˜ï¼Œé‡æ–°è¯»å– (5ms)

åœºæ™¯3: æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç”¨æˆ·: /cache stats
Agent: 
  ğŸ“Š Cache Statistics
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Total entries: 42
  Hit rate: 68% (156 hits / 229 lookups)
  Time saved: ~3m 24s
  
  By tool:
    websearch: 85% hit rate (12 entries)
    git:       72% hit rate (8 entries)
    grep:      45% hit rate (15 entries)
    view:      90% hit rate (7 entries)

åœºæ™¯4: æ‰‹åŠ¨æ¸…é™¤
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç”¨æˆ·: /cache clear websearch
Agent: Cleared 12 websearch cache entries

ç”¨æˆ·: /cache clear
Agent: Cleared all 42 cache entries
```

---

## æŠ€æœ¯æ–¹æ¡ˆ

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Agent                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ReAct Loop   â”‚  â”‚ Tool Calls   â”‚  â”‚ Chat Stream          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                 â”‚                     â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â”‚                                    â”‚
â”‚                           â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Tool Set (Modified)                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Tool    â”‚ â”‚ Tool    â”‚ â”‚ Tool    â”‚ â”‚ CachedTool      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ Shell   â”‚ â”‚ Edit    â”‚ â”‚ Git     â”‚ â”‚ Wrapper         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ (raw)   â”‚ â”‚ (raw)   â”‚ â”‚ (cached)â”‚ â”‚                 â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                               â”‚                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                  â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Cache Layer                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  CacheManager                                              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Get()    â”‚  â”‚ Set()    â”‚  â”‚ Invalidateâ”‚ â”‚ Stats()  â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                           â–¼                             â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚  Storage (BadgerDB / LevelDB / JSON file)        â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ Key: tool_name + hash(args + deps)          â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ Value: result + metadata                    â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€ TTL: auto-expire                            â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. `internal/cache/types.go` - ç±»å‹å®šä¹‰

```go
package cache

import (
    "time"
)

// Policy å®šä¹‰ç¼“å­˜ç­–ç•¥
type Policy struct {
    TTL          time.Duration    // ç”Ÿå­˜æ—¶é—´ï¼Œ0è¡¨ç¤ºä¸ç¼“å­˜
    Invalidation InvalidationType // å¤±æ•ˆç±»å‹
}

// InvalidationType ç¼“å­˜å¤±æ•ˆç±»å‹
type InvalidationType int

const (
    NeverCache   InvalidationType = iota // æ°¸ä¸ç¼“å­˜
    NoInvalidation                       // ä»…åŸºäºTTL
    MTime                                // åŸºäºæ–‡ä»¶ä¿®æ”¹æ—¶é—´
    Content                              // åŸºäºå†…å®¹å“ˆå¸Œ
    GitHead                              // åŸºäº Git HEAD
)

// Entry ç¼“å­˜æ¡ç›®
type Entry struct {
    Key        string            `json:"key"`
    Result     string            `json:"result"`
    CreatedAt  time.Time         `json:"created_at"`
    ExpiresAt  time.Time         `json:"expires_at"`
    Dependencies map[string]any  `json:"deps,omitempty"` // å¤±æ•ˆä¾èµ–
    HitCount   int               `json:"hit_count"`
    LastHitAt  *time.Time        `json:"last_hit_at,omitempty"`
}

// Stats ç¼“å­˜ç»Ÿè®¡
type Stats struct {
    TotalEntries int           `json:"total_entries"`
    TotalHits    int64         `json:"total_hits"`
    TotalMisses  int64         `json:"total_misses"`
    HitRate      float64       `json:"hit_rate"` // 0-1
    TimeSaved    time.Duration `json:"time_saved"` // ä¼°ç®—èŠ‚çœæ—¶é—´
}

// Key ç”Ÿæˆç¼“å­˜é”®
type Key struct {
    ToolName string
    ArgsHash string
    DepsHash string // ä¾èµ–çŠ¶æ€å“ˆå¸Œ
}

func (k Key) String() string {
    if k.DepsHash != "" {
        return k.ToolName + ":" + k.ArgsHash + ":" + k.DepsHash
    }
    return k.ToolName + ":" + k.ArgsHash
}
```

#### 2. `internal/cache/manager.go` - ç¼“å­˜ç®¡ç†å™¨

```go
package cache

import (
    "context"
    "crypto/sha256"
    "encoding/hex"
    "encoding/json"
    "fmt"
    "os"
    "path/filepath"
    "sync"
    "time"
)

// Manager ç®¡ç†å·¥å…·ç»“æœç¼“å­˜
type Manager struct {
    store    Store
    policies map[string]Policy
    stats    *StatsCollector
    mu       sync.RWMutex
}

// Store æŠ½è±¡å­˜å‚¨æ¥å£
type Store interface {
    Get(key string) (*Entry, error)
    Set(key string, entry *Entry) error
    Delete(key string) error
    DeletePrefix(prefix string) error
    List() ([]*Entry, error)
    Close() error
}

func NewManager(store Store) *Manager {
    return &Manager{
        store:    store,
        policies: defaultPolicies(),
        stats:    newStatsCollector(),
    }
}

// Get è·å–ç¼“å­˜ç»“æœ
func (m *Manager) Get(ctx context.Context, toolName string, args json.RawMessage) (*Entry, bool) {
    policy, ok := m.policies[toolName]
    if !ok || policy.TTL == 0 {
        m.stats.RecordMiss(toolName)
        return nil, false
    }
    
    // ç”Ÿæˆç¼“å­˜é”®
    key := m.makeKey(toolName, args, policy.Invalidation)
    
    entry, err := m.store.Get(key.String())
    if err != nil {
        m.stats.RecordMiss(toolName)
        return nil, false
    }
    
    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    if time.Now().After(entry.ExpiresAt) {
        m.store.Delete(key.String())
        m.stats.RecordMiss(toolName)
        return nil, false
    }
    
    // éªŒè¯ä¾èµ–æ˜¯å¦å˜åŒ–
    if !m.validateDeps(entry.Dependencies) {
        m.store.Delete(key.String())
        m.stats.RecordMiss(toolName)
        return nil, false
    }
    
    // æ›´æ–°å‘½ä¸­ç»Ÿè®¡
    entry.HitCount++
    now := time.Now()
    entry.LastHitAt = &now
    m.store.Set(key.String(), entry)
    
    m.stats.RecordHit(toolName)
    return entry, true
}

// Set å­˜å‚¨ç¼“å­˜ç»“æœ
func (m *Manager) Set(ctx context.Context, toolName string, args json.RawMessage, result string, execTime time.Duration) error {
    policy, ok := m.policies[toolName]
    if !ok || policy.TTL == 0 {
        return nil
    }
    
    // ä¸ç¼“å­˜é”™è¯¯ç»“æœï¼ˆå¯é…ç½®ï¼‰
    if len(result) > 0 && result[0:6] == "error:" {
        return nil
    }
    
    key := m.makeKey(toolName, args, policy.Invalidation)
    deps := m.collectDeps(toolName, args, policy.Invalidation)
    
    entry := &Entry{
        Key:          key.String(),
        Result:       result,
        CreatedAt:    time.Now(),
        ExpiresAt:    time.Now().Add(policy.TTL),
        Dependencies: deps,
        HitCount:     0,
    }
    
    m.stats.RecordSave(toolName, execTime)
    return m.store.Set(key.String(), entry)
}

// Invalidate ä½¿ç¼“å­˜å¤±æ•ˆ
func (m *Manager) Invalidate(pattern string) error {
    // æ”¯æŒé€šé…ç¬¦: "git:*", "*"
    if pattern == "*" {
        entries, _ := m.store.List()
        for _, e := range entries {
            m.store.Delete(e.Key)
        }
        return nil
    }
    return m.store.DeletePrefix(pattern)
}

// Stats è¿”å›ç»Ÿè®¡ä¿¡æ¯
func (m *Manager) Stats() Stats {
    return m.stats.Snapshot()
}

// StatsByTool è¿”å›å„å·¥å…·çš„ç»Ÿè®¡
func (m *Manager) StatsByTool() map[string]ToolStats {
    return m.stats.ByTool()
}

// makeKey ç”Ÿæˆç¼“å­˜é”®
func (m *Manager) makeKey(toolName string, args json.RawMessage, invType InvalidationType) Key {
    argsHash := hashBytes(args)
    
    var depsHash string
    switch invType {
    case MTime, Content:
        depsHash = m.hashFileDeps(args)
    case GitHead:
        depsHash = m.getGitHead()
    }
    
    return Key{
        ToolName: toolName,
        ArgsHash: argsHash,
        DepsHash: depsHash,
    }
}

// collectDeps æ”¶é›†ä¾èµ–ä¿¡æ¯
func (m *Manager) collectDeps(toolName string, args json.RawMessage, invType InvalidationType) map[string]any {
    deps := make(map[string]any)
    
    switch invType {
    case MTime:
        // ä» args ä¸­æå–è·¯å¾„ï¼Œè®°å½• mtime
        if path := extractPathFromArgs(args); path != "" {
            if info, err := os.Stat(path); err == nil {
                deps["mtime"] = info.ModTime().Unix()
                deps["path"] = path
            }
        }
    case GitHead:
        deps["head"] = m.getGitHead()
    }
    
    return deps
}

// validateDeps éªŒè¯ä¾èµ–æ˜¯å¦å˜åŒ–
func (m *Manager) validateDeps(deps map[string]any) bool {
    if len(deps) == 0 {
        return true
    }
    
    // æ£€æŸ¥ mtime
    if path, ok := deps["path"].(string); ok {
        if mtime, ok := deps["mtime"].(int64); ok {
            if info, err := os.Stat(path); err == nil {
                if info.ModTime().Unix() != mtime {
                    return false
                }
            }
        }
    }
    
    // æ£€æŸ¥ git HEAD
    if head, ok := deps["head"].(string); ok {
        if m.getGitHead() != head {
            return false
        }
    }
    
    return true
}

// getGitHead è·å–å½“å‰ Git HEAD
func (m *Manager) getGitHead() string {
    // ç¼“å­˜ HEAD é¿å…é¢‘ç¹æ‰§è¡Œ git
    head, _ := exec.Command("git", "rev-parse", "HEAD").Output()
    return strings.TrimSpace(string(head))
}

func hashBytes(data []byte) string {
    h := sha256.Sum256(data)
    return hex.EncodeToString(h[:8]) // å‰8å­—èŠ‚è¶³å¤Ÿ
}
```

#### 3. `internal/cache/store.go` - å­˜å‚¨å®ç°

```go
package cache

import (
    "encoding/json"
    "os"
    "path/filepath"
    "strings"
    "sync"
)

// FileStore åŸºäºæ–‡ä»¶çš„ç¼“å­˜å­˜å‚¨
type FileStore struct {
    dir string
    mu  sync.RWMutex
}

func NewFileStore(dir string) (*FileStore, error) {
    if err := os.MkdirAll(dir, 0755); err != nil {
        return nil, err
    }
    return &FileStore{dir: dir}, nil
}

func (s *FileStore) Get(key string) (*Entry, error) {
    s.mu.RLock()
    defer s.mu.RUnlock()
    
    path := s.keyPath(key)
    data, err := os.ReadFile(path)
    if err != nil {
        return nil, err
    }
    
    var entry Entry
    if err := json.Unmarshal(data, &entry); err != nil {
        return nil, err
    }
    return &entry, nil
}

func (s *FileStore) Set(key string, entry *Entry) error {
    s.mu.Lock()
    defer s.mu.Unlock()
    
    path := s.keyPath(key)
    if err := os.MkdirAll(filepath.Dir(path), 0755); err != nil {
        return err
    }
    
    data, err := json.Marshal(entry)
    if err != nil {
        return err
    }
    
    return os.WriteFile(path, data, 0644)
}

func (s *FileStore) Delete(key string) error {
    s.mu.Lock()
    defer s.mu.Unlock()
    
    path := s.keyPath(key)
    return os.Remove(path)
}

func (s *FileStore) DeletePrefix(prefix string) error {
    s.mu.Lock()
    defer s.mu.Unlock()
    
    entries, _ := s.listLocked()
    for _, e := range entries {
        if strings.HasPrefix(e.Key, prefix) {
            os.Remove(s.keyPath(e.Key))
        }
    }
    return nil
}

func (s *FileStore) List() ([]*Entry, error) {
    s.mu.RLock()
    defer s.mu.RUnlock()
    return s.listLocked()
}

func (s *FileStore) listLocked() ([]*Entry, error) {
    var entries []*Entry
    
    err := filepath.Walk(s.dir, func(path string, info os.FileInfo, err error) error {
        if err != nil || info.IsDir() {
            return nil
        }
        if filepath.Ext(path) != ".json" {
            return nil
        }
        
        data, err := os.ReadFile(path)
        if err != nil {
            return nil
        }
        
        var entry Entry
        if err := json.Unmarshal(data, &entry); err == nil {
            entries = append(entries, &entry)
        }
        return nil
    })
    
    return entries, err
}

func (s *FileStore) Close() error {
    return nil
}

func (s *FileStore) keyPath(key string) string {
    // ä½¿ç”¨ä¸¤å±‚ç›®å½•ç»“æ„é¿å…å•ç›®å½•æ–‡ä»¶è¿‡å¤š
    // key: "websearch:abc123:def456" -> "we/bsearch_abc123_def456.json"
    safeKey := sanitizeKey(key)
    if len(safeKey) < 4 {
        return filepath.Join(s.dir, safeKey+".json")
    }
    return filepath.Join(s.dir, safeKey[:2], safeKey[2:]+".json")
}

func sanitizeKey(key string) string {
    // æ›¿æ¢ä¸å®‰å…¨å­—ç¬¦
    replacer := strings.NewReplacer(
        "/", "_",
        "\\", "_",
        ":", "_",
    )
    return replacer.Replace(key)
}
```

#### 4. `internal/cache/wrapper.go` - å·¥å…·åŒ…è£…å™¨

```go
package cache

import (
    "context"
    "encoding/json"
    "time"
    
    "github.com/abcdlsj/otter/internal/tool"
)

// WrappedTool åŒ…è£…å·¥å…·ï¼Œæ·»åŠ ç¼“å­˜èƒ½åŠ›
type WrappedTool struct {
    inner   tool.Tool
    cache   *Manager
    name    string
}

func Wrap(t tool.Tool, cache *Manager) *WrappedTool {
    return &WrappedTool{
        inner: t,
        cache: cache,
        name:  t.Name(),
    }
}

func (w *WrappedTool) Name() string { return w.inner.Name() }
func (w *WrappedTool) Desc() string { return w.inner.Desc() }
func (w *WrappedTool) Args() map[string]any { return w.inner.Args() }

func (w *WrappedTool) Run(ctx context.Context, args json.RawMessage) (string, error) {
    // å°è¯•ä»ç¼“å­˜è·å–
    if entry, hit := w.cache.Get(ctx, w.name, args); hit {
        return entry.Result, nil
    }
    
    // æ‰§è¡Œå®é™…å·¥å…·
    start := time.Now()
    result, err := w.inner.Run(ctx, args)
    execTime := time.Since(start)
    
    if err != nil {
        return "", err
    }
    
    // å­˜å…¥ç¼“å­˜
    w.cache.Set(ctx, w.name, args, result, execTime)
    
    return result, nil
}
```

#### 5. `internal/cache/stats.go` - ç»Ÿè®¡æ”¶é›†

```go
package cache

import (
    "sync"
    "time"
)

// ToolStats å•ä¸ªå·¥å…·çš„ç»Ÿè®¡
type ToolStats struct {
    Hits       int64
    Misses     int64
    Entries    int
    TimeSaved  time.Duration
    AvgExecTime time.Duration
}

// StatsCollector ç»Ÿè®¡æ”¶é›†å™¨
type StatsCollector struct {
    hits       map[string]int64
    misses     map[string]int64
    execTimes  map[string][]time.Duration
    mu         sync.RWMutex
}

func newStatsCollector() *StatsCollector {
    return &StatsCollector{
        hits:      make(map[string]int64),
        misses:    make(map[string]int64),
        execTimes: make(map[string][]time.Duration),
    }
}

func (s *StatsCollector) RecordHit(toolName string) {
    s.mu.Lock()
    defer s.mu.Unlock()
    s.hits[toolName]++
}

func (s *StatsCollector) RecordMiss(toolName string) {
    s.mu.Lock()
    defer s.mu.Unlock()
    s.misses[toolName]++
}

func (s *StatsCollector) RecordSave(toolName string, execTime time.Duration) {
    s.mu.Lock()
    defer s.mu.Unlock()
    s.execTimes[toolName] = append(s.execTimes[toolName], execTime)
}

func (s *StatsCollector) Snapshot() Stats {
    s.mu.RLock()
    defer s.mu.RUnlock()
    
    var totalHits, totalMisses int64
    var totalSaved time.Duration
    
    for _, h := range s.hits {
        totalHits += h
    }
    for _, m := range s.misses {
        totalMisses += m
    }
    
    total := totalHits + totalMisses
    hitRate := 0.0
    if total > 0 {
        hitRate = float64(totalHits) / float64(total)
    }
    
    // ä¼°ç®—èŠ‚çœæ—¶é—´ = å‘½ä¸­æ¬¡æ•° Ã— å¹³å‡æ‰§è¡Œæ—¶é—´
    for tool, times := range s.execTimes {
        if len(times) == 0 {
            continue
        }
        var sum time.Duration
        for _, t := range times {
            sum += t
        }
        avg := sum / time.Duration(len(times))
        totalSaved += avg * time.Duration(s.hits[tool])
    }
    
    return Stats{
        TotalHits:   totalHits,
        TotalMisses: totalMisses,
        HitRate:     hitRate,
        TimeSaved:   totalSaved,
    }
}

func (s *StatsCollector) ByTool() map[string]ToolStats {
    s.mu.RLock()
    defer s.mu.RUnlock()
    
    result := make(map[string]ToolStats)
    
    // æ”¶é›†æ‰€æœ‰å·¥å…·åç§°
    allTools := make(map[string]bool)
    for t := range s.hits {
        allTools[t] = true
    }
    for t := range s.misses {
        allTools[t] = true
    }
    
    for t := range allTools {
        hits := s.hits[t]
        misses := s.misses[t]
        total := hits + misses
        
        hitRate := 0.0
        if total > 0 {
            hitRate = float64(hits) / float64(total)
        }
        
        var avgExec time.Duration
        if times := s.execTimes[t]; len(times) > 0 {
            var sum time.Duration
            for _, d := range times {
                sum += d
            }
            avgExec = sum / time.Duration(len(times))
        }
        
        result[t] = ToolStats{
            Hits:        hits,
            Misses:      misses,
            HitRate:     hitRate,
            TimeSaved:   avgExec * time.Duration(hits),
            AvgExecTime: avgExec,
        }
    }
    
    return result
}
```

### æ–‡ä»¶æ”¹åŠ¨æ¸…å•

```
æ–°å¢æ–‡ä»¶:
â”œâ”€â”€ internal/cache/
â”‚   â”œâ”€â”€ types.go           # æ ¸å¿ƒç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ manager.go         # ç¼“å­˜ç®¡ç†å™¨
â”‚   â”œâ”€â”€ store.go           # å­˜å‚¨å®ç°
â”‚   â”œâ”€â”€ wrapper.go         # å·¥å…·åŒ…è£…å™¨
â”‚   â””â”€â”€ stats.go           # ç»Ÿè®¡æ”¶é›†
â”œâ”€â”€ internal/cache/store/
â”‚   â””â”€â”€ badger.go          # BadgerDB å­˜å‚¨å®ç° (å¯é€‰)

ä¿®æ”¹æ–‡ä»¶:
â”œâ”€â”€ internal/config/config.go
â”‚   â””â”€â”€ æ·»åŠ  CacheConfig é…ç½®
â”œâ”€â”€ internal/tool/tool.go
â”‚   â””â”€â”€ NewSet() é›†æˆç¼“å­˜åŒ…è£…
â””â”€â”€ main.go
    â””â”€â”€ åˆå§‹åŒ–ç¼“å­˜ç®¡ç†å™¨
```

---

## æ¥å£è®¾è®¡

### TUI å‘½ä»¤

```
/cache                 æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡æ¦‚è§ˆ
/cache stats           è¯¦ç»†ç»Ÿè®¡ï¼ˆæŒ‰å·¥å…·ï¼‰
/cache clear           æ¸…é™¤æ‰€æœ‰ç¼“å­˜
/cache clear <tool>    æ¸…é™¤æŒ‡å®šå·¥å…·çš„ç¼“å­˜ï¼ˆå¦‚ /cache clear websearchï¼‰
/cache enable <tool>   å¯ç”¨æŒ‡å®šå·¥å…·çš„ç¼“å­˜
/cache disable <tool>  ç¦ç”¨æŒ‡å®šå·¥å…·çš„ç¼“å­˜
```

### é…ç½®é¡¹

```toml
[cache]
enabled = true
dir = "~/.config/otter/cache"  # ç¼“å­˜ç›®å½•
max_size_mb = 100              # æœ€å¤§ç¼“å­˜å¤§å°

[cache.policies]
# è‡ªå®šä¹‰ç¼“å­˜ç­–ç•¥ï¼ˆè¦†ç›–é»˜è®¤ï¼‰
websearch = { ttl = "2h", invalidation = "none" }
grep = { ttl = "5m", invalidation = "content" }

# ç¦ç”¨ç‰¹å®šå·¥å…·ç¼“å­˜
[cache.disabled]
shell = true
edit = true
```

### ç¯å¢ƒå˜é‡

```bash
export OTTER_CACHE_ENABLED=1
export OTTER_CACHE_DIR=/tmp/otter-cache
export OTTER_CACHE_MAX_SIZE_MB=200
```

---

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½æµ‹è¯•

- [ ] å¯ç”¨ç¼“å­˜åï¼Œé‡å¤çš„ websearch æŸ¥è¯¢ä»ç¼“å­˜è¿”å›ï¼ˆ<1msï¼‰
- [ ] view å·¥å…·åœ¨æ–‡ä»¶æœªä¿®æ”¹æ—¶è¿”å›ç¼“å­˜ç»“æœ
- [ ] view å·¥å…·åœ¨æ–‡ä»¶ä¿®æ”¹åè‡ªåŠ¨å¤±æ•ˆå¹¶é‡æ–°è¯»å–
- [ ] git å·¥å…·åœ¨ HEAD å˜åŒ–åè‡ªåŠ¨å¤±æ•ˆ
- [ ] `/cache` å‘½ä»¤æ˜¾ç¤ºæ­£ç¡®çš„ç»Ÿè®¡ä¿¡æ¯
- [ ] `/cache clear websearch` ä»…æ¸…é™¤ websearch ç¼“å­˜
- [ ] `/cache clear` æ¸…é™¤æ‰€æœ‰ç¼“å­˜
- [ ] ç¦ç”¨ç¼“å­˜çš„å·¥å…·æ¯æ¬¡é‡æ–°æ‰§è¡Œ
- [ ] ç¼“å­˜ç»“æœåœ¨ä¼šè¯é‡å¯åä»ç„¶æœ‰æ•ˆï¼ˆæŒä¹…åŒ–ï¼‰

### è¾¹ç•Œæµ‹è¯•

- [ ] ç¼“å­˜æ¡ç›®è¿‡æœŸåè‡ªåŠ¨æ¸…ç†
- [ ] ç¼“å­˜ç›®å½•ä¸å¯å†™æ—¶ä¼˜é›…é™çº§ï¼ˆæ— ç¼“å­˜ï¼Œä¸æŠ¥é”™ï¼‰
- [ ] å¹¶å‘è®¿é—®åŒä¸€ç¼“å­˜æ¡ç›®å®‰å…¨
- [ ] æŸåçš„ç¼“å­˜æ–‡ä»¶è‡ªåŠ¨å¿½ç•¥å¹¶é‡æ–°ç”Ÿæˆ
- [ ] å¤§ç»“æœï¼ˆ>1MBï¼‰çš„ç¼“å­˜å¤„ç†

### æ€§èƒ½æµ‹è¯•

- [ ] ç¼“å­˜å‘½ä¸­æ—¶å»¶ < 1ms
- [ ] ç¼“å­˜æœªå‘½ä¸­æ—¶å»¶å¢åŠ  < 5%ï¼ˆç›¸å¯¹äºç›´æ¥æ‰§è¡Œï¼‰
- [ ] å¯åŠ¨æ—¶åŠ è½½ç¼“å­˜ä¸å½±å“å¯åŠ¨æ—¶é—´ï¼ˆ<100msï¼‰
- [ ] å†…å­˜å ç”¨ç¨³å®šï¼Œæ— å†…å­˜æ³„æ¼

### ä»£ç è´¨é‡

- [ ] éµå¾ª CLAUDE.md ä»£ç é£æ ¼
- [ ] å®Œæ•´é”™è¯¯å¤„ç†
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 70%
- [ ] ä¸å¼•å…¥é‡é‡çº§ä¾èµ–ï¼ˆBadgerDB ä¸ºå¯é€‰ï¼‰

---

## å‚è€ƒ

### ç›¸å…³é¡¹ç›®

1. **curl** - HTTP ç¼“å­˜æœºåˆ¶
   - `--cache` é€‰é¡¹å®ç°

2. ** Poetry** - Python ä¾èµ–ç¼“å­˜
   - åŸºäºæ–‡ä»¶å“ˆå¸Œçš„ç¼“å­˜å¤±æ•ˆ

3. **esbuild** - æ„å»ºç¼“å­˜
   - mtime å’Œå†…å®¹åŒé‡éªŒè¯

### æŠ€æœ¯æ–‡æ¡£

1. **Go å¹¶å‘æ¨¡å¼**
   - https://go.dev/blog/pipelines

2. **BadgerDB** (å¯é€‰é«˜æ€§èƒ½å­˜å‚¨)
   - https://github.com/dgraph-io/badger

### ä»£ç å‚è€ƒ

æ–‡ä»¶å“ˆå¸Œè®¡ç®—ï¼š
```go
func fileHash(path string) (string, error) {
    f, err := os.Open(path)
    if err != nil {
        return "", err
    }
    defer f.Close()
    
    h := sha256.New()
    if _, err := io.Copy(h, f); err != nil {
        return "", err
    }
    return hex.EncodeToString(h.Sum(nil)[:8]), nil
}
```

---

*PRD ç‰ˆæœ¬: 1.0*  
*åˆ›å»ºæ—¥æœŸ: 2026-02-12*  
*ä½œè€…: OpenClaw Agent*
