# Feature: Image Support (图像支持)

## 背景与动机

### 现状
Otter 目前是一个纯文本的终端 AI Agent，用户只能通过文本与 LLM 交互。然而，现代主流 LLM 已经广泛支持多模态能力：

- **Claude 3.5 Sonnet**: 支持图像理解
- **GPT-4o/GPT-4V**: 强大的视觉能力
- **Kimi K2.5**: 支持图像输入
- **Gemini**: 原生多模态

### 为什么需要这个功能

1. **错误诊断**: 用户可以直接粘贴终端错误截图，无需手动复制文本
2. **UI 实现**: 上传设计图/mockup，让 AI 帮助生成对应的代码
3. **代码审查**: 粘贴代码截图询问问题（在无法直接复制代码的场景）
4. **图表理解**: 分析架构图、流程图、数据可视化
5. **文档处理**: 查看和解析包含图表的技术文档

### 竞品对比

| 工具 | 图像支持 | 说明 |
|------|----------|------|
| Claude Code | ❌ | 纯文本终端 |
| Claude Desktop | ✅ | 完整图像支持 |
| Cursor | ✅ | 支持截图粘贴 |
| Windsurf | ✅ | 支持图像输入 |
| Otter | ❌ | **待实现** |

图像支持将使 Otter 成为功能更完整的终端 AI 助手。

---

## 功能描述

### 核心功能

1. **图像上传**: 支持从剪贴板粘贴图像到 TUI
2. **图像显示**: 在终端中显示图像信息（文件名、尺寸、格式）
3. **多模态消息**: 消息可以同时包含文本和图像
4. **模型适配**: 自动检测模型是否支持 vision，不支持则提示

### 使用场景

```
用户: [粘贴一张 React 错误截图]
      "这个报错是什么原因？"

Otter: [分析图像中的错误信息]
       "这是一个常见的 React Hook 依赖问题...
        在 useEffect 的第 12 行，你需要添加..."
```

```
用户: [粘贴一张 UI 设计图]
      "帮我实现这个登录页面"

Otter: [分析设计图的颜色、布局、元素]
       "我来帮你实现这个登录页面...
       首先创建组件结构..."
```

---

## 技术方案

### 架构改动

```
┌─────────────────────────────────────────────────────────────┐
│                         TUI (BubbleTea)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │   TextArea   │  │ ImagePreview │  │   Paste      │       │
│  │   (输入)     │  │  (图像信息)  │  │  Handler     │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      Message System                         │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Msg Structure (Multi-modal)                          │  │
│  │  ├── Role: string                                     │  │
│  │  ├── Text: string                                     │  │
│  │  └── Images: []Image {                                │  │
│  │        Data: base64                                   │  │
│  │        Type: "png" | "jpeg" | "webp"                  │  │
│  │        Size: {width, height}                          │  │
│  │      }                                                │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      LLM Client                             │
│  ┌────────────────┐  ┌────────────────┐  ┌──────────────┐  │
│  │   Anthropic    │  │    OpenAI      │  │    Kimi      │  │
│  │  (Claude API)  │  │  (GPT-4V)      │  │  (Vision)    │  │
│  └────────────────┘  └────────────────┘  └──────────────┘  │
│                                                              │
│  统一接口: Chat(ctx, messages, tools, images)                │
└─────────────────────────────────────────────────────────────┘
```

### 文件改动清单

#### 1. `internal/types/types.go` (新增/修改)

新增 Image 类型和多媒体消息支持：

```go
// Image represents an image in a message
type Image struct {
    Data   string // base64 encoded
    Type   string // "png", "jpeg", "webp", "gif"
    Width  int
    Height int
}

// Message represents a multimodal message
type Message struct {
    Role        string
    Content     string
    Images      []Image
    ToolCalls   []ToolCall
    ToolResults []ToolResult
}
```

#### 2. `internal/msg/msg.go` (修改)

更新 Msg 结构支持图像：

```go
type Msg struct {
    ID          string
    Role        string
    Text        string
    Images      []ImageData  // 新增
    ToolCalls   []types.ToolCall
    ToolResults []types.ToolResult
    Timestamp   time.Time
}

type ImageData struct {
    Path   string // 本地缓存路径
    Type   string
    Width  int
    Height int
}
```

会话持久化需要支持图像元数据（图像本身存本地，jsonl 存路径）。

#### 3. `internal/llm/llm.go` & `internal/llm/anthropic.go` (修改)

为 Anthropic 客户端添加图像支持：

```go
// 在 Message 结构中添加 Images
 type Message struct {
     Role             string
     Content          string
     Images           []ImageContent  // 新增
     ReasoningContent string
     ToolCalls        []types.ToolCall
     ToolResults      []types.ToolResult
 }
 
 type ImageContent struct {
     Type   string // image
     Source struct {
         Type      string // base64
         MediaType string // image/png, image/jpeg, etc.
         Data      string
     }
 }
```

Anthropic API 格式：
```json
{
  "role": "user",
  "content": [
    {"type": "image", "source": {"type": "base64", "media_type": "image/png", "data": "..."}},
    {"type": "text", "text": "这是什么错误？"}
  ]
}
```

#### 4. `internal/tui/tui.go` (修改)

主要改动：

1. **添加图像处理**: 
   - 集成 `clipboard` 库读取剪贴板图像
   - 支持 `Ctrl+V` 粘贴图像
   - 图像预览区域（显示文件名/尺寸）

2. **新增快捷键**:
   - `Ctrl+V`: 粘贴图像（自动检测剪贴板内容）
   - `Ctrl+Shift+V`: 显式粘贴图像（即使剪贴板有文本也尝试读取图像）

3. **UI 更新**:
   - 输入框上方显示待发送的图像缩略信息
   - 聊天记录中显示图像占位符

依赖库：
```go
import "golang.design/x/clipboard"
```

#### 5. `internal/config/config.go` (修改)

添加图像相关配置：

```toml
[image]
enabled = true              # 是否启用图像支持
max_size = 5242880          # 最大图像大小 (5MB)
max_dimension = 4096        # 最大边长
supported_formats = ["png", "jpeg", "webp", "gif"]
auto_resize = true          # 自动调整过大图像
```

#### 6. `internal/agent/agent.go` (修改)

适配多模态消息传递，确保 `buildMessages` 正确处理图像。

---

## 接口设计

### 命令行参数

无需新增参数，保持现有接口。

### TUI 快捷键

| 快捷键 | 功能 |
|--------|------|
| `Ctrl+V` | 粘贴（自动检测：图像优先，否则文本） |
| `Ctrl+Shift+V` | 强制粘贴图像 |
| `Ctrl+X` | 清除待发送的图像 |

### 配置项

```toml
[image]
enabled = true
max_size = 5242880          # 5MB
max_dimension = 4096
supported_formats = ["png", "jpeg", "webp"]
auto_resize = true
quality = 85                # JPEG 质量
```

### 支持模型检测

在 `config.toml` 的 model 配置中添加：

```toml
[[providers.models]]
name = "claude-sonnet-4-20250514"
alias = "claude"
default = true
vision = true               # 是否支持图像输入
```

---

## 实现细节

### 图像处理流程

```
1. 用户粘贴 (Ctrl+V)
   │
   ▼
2. 读取剪贴板
   ├── 有图像 → 继续
   └── 无图像 → 尝试粘贴文本
   │
   ▼
3. 图像验证
   ├── 格式检查 (png/jpeg/webp/gif)
   ├── 大小检查 (< 5MB)
   └── 尺寸检查 (< 4096px)
   │
   ▼
4. 图像预处理
   ├── 自动压缩 (如启用)
   └── 转换为 base64
   │
   ▼
5. 显示预览
   │
   ▼
6. 用户发送消息
   │
   ▼
7. 随消息发送到 LLM
```

### 图像存储策略

```
~/.config/otter/
├── sessions/
│   └── {workdir}/
│       ├── session.jsonl       # 会话文本记录
│       └── images/             # 会话关联图像
│           ├── img_001_abc123.png
│           ├── img_002_def456.jpg
│           └── ...
└── config.toml
```

- 图像以文件形式存储在 `sessions/{workdir}/images/`
- `jsonl` 中只保存图像元数据（路径、尺寸、类型）
- 避免 base64 直接存 jsonl 导致文件过大

### 降级策略

当使用不支持 vision 的模型时：

```
用户尝试发送带图像的消息
         │
         ▼
检测当前模型 vision 能力
         │
    ┌────┴────┐
    ▼         ▼
 支持图像   不支持
    │         │
    ▼         ▼
 正常发送   提示用户
            "当前模型 {model} 不支持图像输入。
             建议切换到支持视觉的模型，如:
             - claude-sonnet-4-20250514
             - gpt-4o"
```

---

## 验收标准

### 功能测试

- [ ] `Ctrl+V` 可以从剪贴板粘贴 PNG 图像
- [ ] `Ctrl+V` 可以从剪贴板粘贴 JPEG 图像
- [ ] `Ctrl+V` 可以从剪贴板粘贴 WebP 图像
- [ ] 粘贴图像后在输入区上方显示图像信息（格式、尺寸）
- [ ] 发送消息后，图像随消息一起发送给 LLM
- [ ] Claude 3.5 Sonnet 可以正确分析图像内容
- [ ] GPT-4o 可以正确分析图像内容
- [ ] 不支持 vision 的模型会给出友好提示
- [ ] 图像大小超过限制时自动压缩或提示
- [ ] 会话历史正确保存图像元数据
- [ ] 切换会话后图像关联关系保持

### 边界测试

- [ ] 剪贴板无内容时 `Ctrl+V` 无响应
- [ ] 剪贴板为文本时 `Ctrl+V` 正常粘贴文本
- [ ] 超大图像 (>5MB) 正确处理
- [ ] 超大尺寸图像 (>4096px) 正确处理
- [ ] 不支持的图像格式 (BMP/TIFF) 友好提示
- [ ] 网络失败时图像发送优雅降级

### 性能测试

- [ ] 图像 base64 编码不阻塞 TUI
- [ ] 大图压缩在后台进行
- [ ] 会话加载时图像元数据读取快速

### 代码质量

- [ ] 遵循 CLAUDE.md 代码风格
- [ ] 图像处理函数有完整错误处理
- [ ] 新增代码覆盖率达到 70%+
- [ ] 不引入不必要的依赖

---

## 参考

### 相关项目

1. **Claude Desktop**: 图像处理实现参考
   - 支持拖拽/粘贴图像
   - 图像压缩策略

2. **aichat**: 终端 AI 工具
   - GitHub: https://github.com/sigoden/aichat
   - 支持 `--file` 上传图像

3. **shellgpt**: 终端 AI 助手
   - GitHub: https://github.com/TheR1D/shell_gpt
   - 支持图像输入

### 技术文档

1. **Anthropic Vision API**
   - https://docs.anthropic.com/en/docs/build-with-claude/vision

2. **OpenAI Vision API**
   - https://platform.openai.com/docs/guides/vision

3. **clipboard 库**
   - https://pkg.go.dev/golang.design/x/clipboard

### 代码参考

Anthropic API 图像格式：
```json
{
  "model": "claude-sonnet-4-20250514",
  "max_tokens": 1024,
  "messages": [
    {
      "role": "user",
      "content": [
        {
          "type": "image",
          "source": {
            "type": "base64",
            "media_type": "image/jpeg",
            "data": "/9j/4AAQSkZJRg..."
          }
        },
        {
          "type": "text",
          "text": "What's in this image?"
        }
      ]
    }
  ]
}
```

---

## 里程碑

### Phase 1: MVP (核心功能)
- [ ] 剪贴板图像读取
- [ ] Anthropic 客户端图像支持
- [ ] TUI 图像预览
- [ ] 基础配置支持

### Phase 2: 完善
- [ ] OpenAI 客户端图像支持
- [ ] 图像自动压缩
- [ ] 会话图像持久化
- [ ] 模型 vision 能力检测

### Phase 3: 优化
- [ ] 终端图像预览 (ASCII/ kitty graphics)
- [ ] 批量图像上传
- [ ] URL 图像输入

---

*PRD 版本: 1.0*  
*创建日期: 2025-02-09*  
*作者: otter-dev*